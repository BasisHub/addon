rem --- Quality Assurance Receipt Register Update
rem --- Program pou_ca v8.0.0 05Dec2007 (pou_ca)
rem --- Created by c:\codeport_bbj\adx_codeport.bbj v1.1.5 (12/05/2007 11:07:46)

rem --- AddonSoftware Version 8.0.0 - 01Jan2007
rem --- Copyright BASIS International Ltd.  All Rights Reserved.
rem --- All Rights Reserved

    setesc std_error
    seterr std_error

rem --- Retrieve the program path

    pgmdir$=stbl("+dir_pgm",err=*next)

rem --- Retrieve sysinfo data

    sysinfo_template$=stbl("+sysinfo_tpl",err=*next)
    dim sysinfo$:sysinfo_template$
    sysinfo$=stbl("+sysinfo",err=*next)
    milestone=num(stbl("+milestone",err=*next),err=*next)
    firm_id$=sysinfo.firm_id$

rem --- Open/Lock files

    files=18,begfile=1,endfile=files
    dim files$[files],options$[files],ids$[files],templates$[files],channels[files]
    files$[1]="aps_params",ids$[1]="APS_PARAMS"
    files$[2]="ivs_params",ids$[2]="IVS_PARAMS"
    files$[3]="poe-03",ids$[3]="POE_QAHDR"
    files$[4]="poe-04",ids$[4]="POE_RECHDR"
    files$[5]="poe-13",ids$[5]="POE_QADET"
    files$[6]="poe-14",ids$[6]="POE_RECDET"
    files$[7]="poe-23",ids$[7]="POE_QALSDET"
    files$[8]="poe-24",ids$[8]="POE_RECLSDET"
    files$[9]="poe-33",ids$[9]="POE_QABYPO"
    files$[10]="poe-34",ids$[10]="POE_RECBYPO"
    files$[11]="poe-43",ids$[11]="POE_QABYITEM"
    files$[12]="poe-44",ids$[12]="POE_RECBYITM"
    files$[13]="poe-53",ids$[13]="POE_POBYQA"
    files$[14]="poe-54",ids$[14]="POE_POBYREC"
    files$[15]="poe-63",ids$[15]="POE_QAREJDET"
    files$[16]="pom-02",ids$[16]="POC_LINECODE"
    files$[17]="pot-03",ids$[17]="POT_QAREJHST"
    files$[18]="pow-13",ids$[18]="POW_QABYVEN"
    call pgmdir$+"adc_fileopen.aon",action,begfile,endfile,files$[all],options$[all],
:                                   ids$[all],templates$[all],channels[all],batch,status
    if status goto std_exit
    aps01a_dev=channels[1]
    ivs01a_dev=channels[2]
    poe03_dev=channels[3]
    poe04_dev=channels[4]
    poe13_dev=channels[5]
    poe14_dev=channels[6]
    poe23_dev=channels[7]
    poe24_dev=channels[8]
    poe33_dev=channels[9]
    poe34_dev=channels[10]
    poe43_dev=channels[11]
    poe44_dev=channels[12]
    poe53_dev=channels[13]
    poe54_dev=channels[14]
    poe63_dev=channels[15]
    pom02_dev=channels[16]
    pot03_dev=channels[17]
    pow13_dev=channels[18]

rem --- Dimension string templates

    dim aps01a$:templates$[1],ivs01a$:templates$[2],poe03a$:templates$[3],
:       poe04a$:templates$[4],poe13a$:templates$[5],poe14a$:templates$[6],
:       poe23a$:templates$[7],poe24a$:templates$[8],poe33a$:templates$[9],
:       poe34a$:templates$[10],poe43a$:templates$[11],poe44a$:templates$[12],
:       poe53a$:templates$[13],poe54a$:templates$[14],poe63a$:templates$[15],
:       pom02a$:templates$[16],pot03a$:templates$[17],pow13a$:templates$[18]

rem --- Retrieve parameter records

    aps01a_key$=firm_id$+"AP00"
    find record (aps01a_dev,key=aps01a_key$,err=std_missing_params) aps01a$
    ivs01a_key$=firm_id$+"IV00"
    find record (ivs01a_dev,key=ivs01a_key$,err=std_missing_params) ivs01a$

rem --- Open/Lock Files

    if gl$<>"Y" then close (printer_dev,err=*next)

rem --- Parameters

rem --- Initializations

    precision i[1]
    more=1

rem --- Background

    call pgmdir$+"syc_cn.bbx","",0,22,'ce',status

rem --- Run Update?

    msg_id$="AON_UPDT_QUERY"
    dim x$:stbl("+SYSINFO_TPL")
    dim msg_tokens$[1]
    x$=stbl("+SYSINFO")                                                            
    msg_tokens$[1]=x.task_desc$
    gosub disp_message
    if msg_opt$<>"Y" then goto std_exit
    call pgmdir$+"adc_progress.aon","N","","","","",0,pow13_dev,1,meter_num,ignore_status

rem --- Disallow 'M'enu Option In Error Routine

    exit_ctrl=1

rem --- Position Sort File

    read (pow13_dev,key=firm_id$,dom=*next)

rem --- Read Sort Record

    while more

        pow13_k$=key(pow13_dev,end=done)
        if pos(firm_id$=pow13_k$)<>1 then goto done
        read (pow13_dev)

    rem --- Get poe-13 QA Receipt Detail

            read record (poe13_dev,key=pow13_k$,dom=*break) poe13a$

    rem --- Move poe-23 QA Receipt Lot/Serial Detail To poe-24

        if ls$="Y"
        
            read (poe23_dev,key=pow13_k$,dom=*next)

            while more

                poe23_k$=key(poe23_dev,end=*break)
                if pos(pow13_k$=poe23_k$)<>1 then break
                
            next_poe23a:

                read record (poe23_dev) poe23a$
                qnty=poe23a.qty_received
                ucost=poe23a.unit_cost,lsnum$=poe23a.lotser_no$

            rem --- Update Existing poe-24 Record For This Lot/Serial Number

                read (poe24_dev,key=poe23_k$(1,25),dom=*next)

                while more

                    poe24_k$=key(poe24_dev,end=*break)
                    if pos(poe23_k$(1,25)=poe24_k$)<>1 then break
                    read record (poe24_dev) poe24a$
                    if poe24a.lotser_no$<>lsnum$

                        tot_qnty=poe24a.qty_received+qnty
                        tot_cost=poe24a.unit_cost*poe24a.qty_received+ucost*qnty,poe24a.qty_received=tot_qnty,poe24a.unit_cost=tot_cost/tot_qnty
rem                        write record (poe24_dev,key=poe24a.firm_id$+poe24a.vendor_id$+poe24a.receiver_no$+poe24a.po_no$+poe24a.po_line_no$+poe24a.sequence_no$) poe24a$
                        write record (poe24_dev,key=poe24_k$) poe24a$

                    else

                    rem --- Write New poe-24 Record For This Lot/Serial Number

                        seq=0
                        read record (poe23_dev,key=poe23_k$) poe23a$

                        while more

                            seq=seq+1
                            poe24a.po_line_no$=str(seq:"000")
                            if seq<=999
                                write record (poe24_dev,key=poe24_k$,dom=*continue) poe24a$
                            else

                            rem --- Write Consolidated poe-24 Record For Multiple Lot/Serial Numbers

                                qnty=poe24a.qty_received
                                ucost=poe24a.unit_cost
                                read record (poe24_dev,key=poe24a.firm_id$+poe24a.vendor_id$+poe24a.receiver_no$+poe24a.po_no$+poe24a.po_line_no$+"999") poe24a$
                                tot_qnty=poe24a.qty_received+qnty
                                tot_cost=poe24a.unit_cost*poe24a.qty_received+ucost*qnty,poe24a.qty_received=tot_qnty,poe24a.unit_cost=tot_cost/tot_qnty,poe24a.lotser_no$="Consolidated Lot/Serial"
                                write record (poe24_dev,key=poe24_k$) poe24a$
                            fi
                            break

                        wend

                    fi
                    break

                wend

                remove (poe23_dev,key=poe23_k$)

            wend

        endif

        rem --- Move poe-63 QA Receipt Rejection Detail To pot-03

        while more
        
            seq=999
            pot03_k$=""
            read (pot03_dev,key=pow13_k$+str(seq:"000"),dom=missing_key_0)
            break

        missing_key_0:

            seq=0
            pot03_k$=keyp(pot03_dev,end=*next)
            if pos(pow13_k$=pot03_k$)=1 then let seq=num(pot03_k$(26,3))

        wend

        read (poe63_dev,key=pow13_k$,dom=*next)

        while more

            poe63_k$=key(poe63_dev,end=*break)
            if pos(pow13_k$=poe63_k$)<>1 then break
            read record (poe63_dev) poe63a$

        rem --- Write Next pot-03 Record

            flag=0
            while more

                if seq=999 then flag=1;break
                seq=seq+1
                pot03_key$=pow13_k$+str(seq:"000")
                write record (pot03_dev,key=pot03_key$,dom=*continue) pot03a$
                remove (poe63_dev,key=poe63_k$)
                break

            wend

            if flag=0 continue

        rem --- Write Consolidated pot-03 Record

            rejected=pot03a.qty_reject
            pot03_key$=pow13_k$+"999"
            read record (pot03_dev,key=pot03_key$,dom=missing_key_1) pot03a$
            pot03a.reject_code$=":::"
            pot03a.ra_no$="Consolidated",pot03a.qty_reject=pot03a.qty_reject+rejected

        missing_key_1:

            write record (pot03_dev,key=pot03_key$) pot03a$

        wend

        rem --- Move poe-13 QA Receipt Detail To poe-14

        ucost=poe14a.unit_cost
rem        qa_received=b[5]
        prev_received=poe14a.qty_received
        read record (poe14_dev,key=pow13_k$,dom=missing_key_2) poe14a$
        tot_received=poe14a.qty_received+qa_received
        tot_cost=poe14a.unit_cost*poe14a.qty_received+ucost*qa_received
        if tot_received=0 
            let poe14a.qty_received=0,poe14a.unit_cost=0
        else
            poe14a.qty_received=tot_received
            poe14a.unit_cost=tot_cost/tot_received
        fi

        write record (poe14_dev,key=pow13_k$) poe14a$
        goto update_poe13

    missing_key_2: rem --- Write New poe-14 Record

        poe14a.qty_prev_rec=received
rem        b[5]=0,b[6]=0
        poe14a.qty_received=qa_received
        write record (poe14_dev,key=pow13_k$) poe14a$
        read record (pom02_dev,key=firm_id$+poe14a.po_line_code$,dom=missing_key_3) pom02a$
        poe44_k$=pow13_k$(1,2)+poe14a.item_id$+pow13_k$(16,10)+pow13_k$(3,13)
        if pom02a.line_type$ ="S" then write record (poe44_dev,key=poe44_k$) poe44a$

    missing_key_3: rem --- Write New poe-04 Record

        read (poe04_dev,key=pow13_k$(1,22),dom=missing_key_4)
        goto update_poe13

    missing_key_4:

        read record (poe03_dev,key=pow13_k$,dom=*next) poe03a$
        write record (poe04_dev,key=pow13_k$) poe04a$
        poe34_k$=poe04a.firm_id$+poe04a.po_no$+poe04a.vendor_no$+poe04a.receiver_no$
        poe54_k$=poe04a.firm_id$+poe04a.receiver_no$+poe04a.vendor_no$+poe04a.po_no$
        write record (poe34_dev,key=poe34_k$) poe34a$
        write record (poe54_dev,key=poe54_k$) poe54a$

    update_poe13: rem --- Update poe-13 QA Receipt Detail Record

        read record (poe13_dev,key=pow13_k$,dom=*break) poe13a$

        poe13a.qa_wip_qty=poe13a.qa_wip_qty-poe13a.qa_rec_qty-poe13a.qa_rej_qty
        poe13a.qa_rec_qty=0
        poe13a.qa_rej_qty=0

        if poe13a.qa_wip_qty<>0
            write record (poe13_dev,key=pow13_k$) poe13a$
        else

        rem --- Remove Empty poe-13 Record

            remove (poe13_dev,key=pow13_k$,dom=*next)
            remove (poe43_dev,key=pow13_k$(1,2)+poe13a.item_id$+pow13_k$(16,10)+pow13_k$(3,13),dom=*next)

        rem --- If Last poe-13 Detail Record, Remove poe-03 Header Record

            read (poe13_dev,key=pow13_k$(1,22),dom=*next)
            poe13_k$=key(poe13_dev,end=remove_poe03)
            if pos(pow13_k$(1,22)=poe13_k$)=1 then break

        remove_poe03: remove (poe03_dev,key=pow13_k$(1,22),dom=*next)

            remove (poe33_dev,key=pow13_k$(1,2)+pow13_k$(16,7)+pow13_k$(3,13),dom=*next)
            remove (poe53_dev,key=pow13_k$(1,2)+pow13_k$(9,7)+pow13_k$(3,6)+pow13_k$(16,7),dom=*next)

        fi
    rem --- Get Next Sort Record

    wend

rem --- All Done
done:
    goto std_exit

rem #include disp_message.src

disp_message:rem --- Display Message Dialog

    call stbl("+DIR_SYP")+"bac_message.bbj",msg_id$,msg_tokens$[all],msg_opt$,table_chans$[all]
return
	
rem #endinclude disp_message.src

rem #include std_error.src

std_error: rem --- Standard error handler (01Apr2006)

    rd_err_text$=""
    if tcb(5)<>0 and pgm(-1)=pgm(-2) rd_err_text$=pgm(tcb(5))
    call stbl("+DIR_SYP")+"bac_error.bbj",err=std_error_exit,pgm(-2),str(tcb(5):"00000"),
:                                str(err:"000"),rd_err_text$,rd_err_act$
    if pos("EXIT"=rd_err_act$) goto std_error_exit
    if pos("ESCAPE"=rd_err_act$) seterr 0;setesc 0
    if pos("RETRY"=rd_err_act$) retry
std_error_exit:
    master_user$=cvs(stbl("+MASTER_USER",err=std_error_release),2)
    sysinfo_template$=stbl("+SYSINFO_TPL",err=std_error_release)
    dim sysinfo$:sysinfo_template$
    sysinfo$=stbl("+SYSINFO",err=std_error_release)
    if cvs(sysinfo.user_id$,2)=master_user$ escape
std_error_release:
    status=999
    if pgm(-1)<>pgm(-2) exit
    release

rem #endinclude std_error.src
rem #include std_missing_params.src

std_missing_params: rem --- Standard missing parameter handler (15Apr2006)

    rd_err_text$=""
    if tcb(5)<>0 and pgm(-1)=pgm(-2) rd_err_text$=pgm(tcb(5))
    pgmdir$=stbl("+DIR_PGM",err=std_missing_params_exit)
    call pgmdir$+"adc_noparams.aon",err=std_missing_params_exit,pgm(-2),str(tcb(5):"00000"),
:                                   str(err:"000"),rd_err_text$,rd_err_act$
std_missing_params_exit:
    master_user$=cvs(stbl("+MASTER_USER",err=std_missing_params_release),2)
    sysinfo_template$=stbl("+SYSINFO_TPL",err=std_missing_params_release)
    dim sysinfo$:sysinfo_template$
    sysinfo$=stbl("+SYSINFO",err=std_missing_params_release)
    if cvs(sysinfo.user_id$,2)=master_user$ escape
std_missing_params_release:
    status=999
    if pgm(-1)<>pgm(-2) exit
    release

rem #endinclude std_missing_params.src

rem #include std_end.src

std_exit: rem --- Standard program end (01Mar2006)

    call pgmdir$+"adc_progress.aon","D","","","","",0,0,0,meter_num,status
    run pgmdir$+"ads_process_end.aon",err=*next
    release

rem #endinclude std_end.src

    end
